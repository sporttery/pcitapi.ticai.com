var terminalTable,winTicketTable,waitingTicketTable,table,form,$,workListEl={},all_terminal=[],workList=[],waitingTicketEl,winTicketEl,getWorkStatusTimer,getWaitingTicketTimer;getAwardResultTimer;var os=function(){var ua=navigator.userAgent,isWindowsPhone=/(?:Windows Phone)/.test(ua),isSymbian=/(?:SymbianOS)/.test(ua)||isWindowsPhone,isAndroid=/(?:Android)/.test(ua),isFireFox=/(?:Firefox)/.test(ua),isChrome=/(?:Chrome|CriOS)/.test(ua),isTablet=/(?:iPad|PlayBook)/.test(ua)||isAndroid&&!/(?:Mobile)/.test(ua)||isFireFox&&/(?:Tablet)/.test(ua),isPhone=/(?:iPhone)/.test(ua)&&!isTablet,isPc;return{isTablet:isTablet,isPhone:isPhone,isAndroid:isAndroid,isPc:!isPhone&&!isAndroid&&!isSymbian}}();function getWorkStatus(){var url="/api/getTerminal?";workList.length>0&&(url+="terminal_no="+workList.join(",")),all_terminal.length>0&&0==workList.length||$.get(url,(function(data){if(workList.length>0)for(var i=0;i<data.data.length;i++){var d=data.data[i],terminal_no=d.terminal_no,award_status=d.award_status,el=workListEl[terminal_no],oldAwardNo=el.data("value");el&&oldAwardNo!=award_status&&("IDLE"==award_status?(text="空闲",color="green",waitingTicketEl[oldAwardNo]?(waitingTicketEl[oldAwardNo].parents("tr").remove(),delete waitingTicketEl[oldAwardNo]):getWaitingTicket(!0),getAwardResult(oldAwardNo,terminal_no),winTicketEl[oldAwardNo]||winTicketTable.reload()):(text="正在兑奖 <b style='color:red'>票号："+award_status+"</b>",color="blue",waitingTicketEl[award_status]?waitingTicketEl[award_status].toggleClass("red"):getWaitingTicket(!0),winTicketEl[award_status]?winTicketEl[award_status].toggleClass("red"):winTicketTable.reload()),el.data("value",award_status).css("color",color).html(text))}else 0==data.code?(all_terminal=data.data,initTermnal(data.data)):(all_terminal=[],initTermnal([]));getWorkStatusTimer&&clearTimeout(getWorkStatusDelay),getWorkStatusTimer=setTimeout(getWorkStatus,getWorkStatusDelay)}))}function getAwardResult(ticket,terminal_no){$.get("/api/getAwardResult?ticket="+ticket,(function(data){if(0==data.code&&data.data)for(var err=!1,i=0;i<data.data.length;i++){var d=data.data[i],award_no=d.award_no;"成功"==d.msg||"OK"==d.msg?(waitingTicketEl[award_no]&&waitingTicketEl[award_no].parents("tr").remove(),winTicketEl[award_no]&&(award_result_info=d.info,prize_flag=d.prize_flag,award_money=d.prize_value,award_time=d.prize_timestamp,terminal_no=d.PRIZE_UNIT_ID,text="未知",0==prize_flag?text="未兑奖":1==prize_flag?text="已中奖":4==prize_flag?text="未中奖":2==prize_flag?text="中大奖":-1==prize_flag&&(text="已取数"),tr=winTicketEl[award_no].parents("tr"),tr.find("td[data-field=prize_Timestamp] .layui-table-cell").text(award_time),tr.find("td[data-field=msg] .layui-table-cell").text(award_result_info),tr.find("td[data-field=prize_value] .layui-table-cell").text(award_money),tr.find("td[data-field=prize_Unit_Id] .layui-table-cell").text(terminal_no),tr.find("td[data-field=prize_Flag] .layui-table-cell").text(text),winTicketEl[award_no].toggleClass("red"),delete winTicketEl[award_no])):(console.log(ticket,d),err=!0),err&&(getAwardResultTimer&&clearTimeout(getAwardResultTimer),getAwardResultTimer=setTimeout((function(){winTicketTable.reload()}),3e3))}}))}function getWaitingTicket(runOnce){if(runOnce||(getWaitingTicketTimer&&clearTimeout(getWaitingTicketTimer),getWaitingTicketTimer=setTimeout(getWaitingTicket,getWaitingTicketDelay)),0==workList.length)initWaitTable([]);else{var url="/api/getWaitingTicket?terminal_no="+workList.join(",");$.get(url,(function(data){if(waitingTicketTable&&0==data.code&&data.count>0){for(var reload=!1,i=0;i<data.data.length;i++){var d=data.data[i];if(!waitingTicketEl[d.awardNo]){reload=!0;break}}reload&&initWaitTable(data)}else initWaitTable(data)}))}}function initWaitTable(data){waitingTicketTable=table.render({elem:"#waitingTicket",data:data.data||[],page:data.count>10,done:function(res,curr,count){if(waitingTicketEl={},res.data&&res.data.length>0)for(var i=0;i<res.data.length;i++){var d=res.data[i];waitingTicketEl[d.awardNo]=$("#wait_table_"+d.awardNo)}},cols:[[{field:"index",width:"5%",title:"序号"},{field:"terminal_no",width:"20%",title:"终端号"},{field:"awardNo",title:"票号密码",width:"75%",templet:function(d){return'<span id="wait_table_'+d.awardNo+'">'+d.awardNo+"</span>"}}]]})}function doAddAwardTicket(ticket,terminal_no){layui.$.post("/api/addAwardTicket",{ticket:ticket,terminal_no:terminal_no},(function(d){0==d.code&&(waitingTicketTable.reload(),winTicketTable.reload())}))}function addAwardTicketAll(){if(0!=workList.length)if(checkboxData=table.checkStatus("winTicket"),checkboxData.data.length>0){for(var k=0,ticket_arr=[],terminal_arr=[],i=0;i<checkboxData.data.length;i++){var terminal_no=workList[k++];terminal_no||(k=0,terminal_no=workList[k++]),terminal_arr.push(terminal_no),ticket_arr.push(checkboxData.data[i].ticket_idmsg)}doAddAwardTicket(ticket_arr.join(","),terminal_arr.join(","))}else layer.msg("请先至少选择一条记录");else layer.msg("没有工作中的机器")}function addAwardTicket(ticket,terminal_no){if(terminal_no)if(1==terminal_no){var terminal_no;"0"!=(terminal_no=layui.$("#_sel_terminal_no").val())?doAddAwardTicket(ticket,terminal_no):layer.msg("terminal_no 没有选择")}else layer.msg("参数错误");else{terminalArr=all_terminal;var html=['<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">'];html.push('选择彩票机：<select id="_sel_terminal_no">'),html.push('<option value="0">请选择</option>');for(var i=0;i<terminalArr.length;i++)text="暂停状态","START"==terminalArr[i].work_status&&(text="开启状态"),html.push('<option value="'+terminalArr[i].terminal_no+'">'+terminalArr[i].terminal_no+"&nbsp;&nbsp;&nbsp;"+text+"</option>");html.push("</select><br/></html>"),layer.open({type:1,title:!1,closeBtn:!1,area:"360px;",shade:.8,id:"LAY_layuipro",btn:["确认","取消"],btnAlign:"c",moveType:1,content:html.join(""),success:function(layero){var btn;layero.find(".layui-layer-btn").find(".layui-layer-btn0").attr({href:"javascript:void(0)",onclick:'addAwardTicket("'+ticket+'",1)'})}})}}function initWinTicket(){winTicketTable=table.render({elem:"#winTicket",url:"/api/getWinTicket?",page:!0,done:function(res,curr,count){winTicketEl={};for(var i=0;i<res.data.length;i++){var d=res.data[i];winTicketEl[d.ticket_idmsg]=$("#win_ticket_"+d.ticket_idmsg)}},cols:[[{fixed:"left",type:"checkbox"},{field:"ticket_idmsg",width:290,title:"票号密码",templet:function(d){return'<span id="win_ticket_'+d.ticket_idmsg+'">'+d.ticket_idmsg+"</span>"}},{field:"insert_Timestamp",width:165,title:"入库时间",sort:!0},{field:"prize_Timestamp",width:165,title:"兑奖时间",sort:!0},{field:"prize_Flag",title:"兑奖状态",width:120,sort:!0,templet:function(d){return text="未知",0==d.prize_Flag?text="未兑奖":1==d.prize_Flag?text="已中奖":4==d.prize_Flag?text="未中奖":2==d.prize_Flag?text="中大奖":-1==d.prize_Flag&&(text="已取数"),text}},{field:"prize_value",width:110,title:"中奖金额",minWidth:40,sort:!0},{field:"prize_Unit_Id",width:150,title:"兑奖机器",sort:!0},{field:"station_Id",width:80,title:"站点"},{field:"msg",title:"兑奖信息",sort:!0},{title:"操作",fixed:"right",width:178,align:"center",templet:function(d){return'<a href="javascript:void(0)" class="layui-btn  layui-btn-sm " onclick="addAwardTicket(\''+d.ticket_idmsg+"')\">重新兑奖</a>"}}]]})}function initTermnal(data){terminalTable=table.render({elem:"#terminal",data:data,limit:data.length,done:function(res,curr,count){if(workListEl={},res.data&&res.data.length>0)for(var i=0;i<res.data.length;i++){var d=res.data[i];"START"==d.work_status&&(workListEl[d.terminal_no]=$("#award_status_"+d.terminal_no),workList.push(d.terminal_no))}getWaitingTicket()},cols:[[{width:"5%",type:"numbers",title:"序号"},{field:"terminal_no",width:"10%",title:"编号",sort:!0},{field:"pwd",width:"10%",title:"密码",align:"center",templet:function(d){return d.pwd1+"&nbsp;&nbsp;"+d.pwd2}},{field:"award_status",width:os.isPc?"65%":"200",title:"兑奖状态",templet:function(d){return"IDLE"==d.award_status?(text="空闲",color="green"):(text="正在兑奖 <b style='color:red'>票号："+d.award_status+"</b>",color="blue"),'<span id="award_status_'+d.terminal_no+'" data-value="'+d.award_status+'" style="color:'+color+'">'+text+"</span>"}},{field:"work_status",width:os.isPc?"10%":"120",fixed:"right",align:"center",title:"工作状态",templet:"#checkboxWorkStatus"}]]})}layui.use("table",(function(){table=layui.table,form=layui.form,$=layui.$,getWorkStatus(!0),initWinTicket(),form.on("checkbox(checkboxWorkStatus)",(function(obj){var terminal_no=this.value;$.get("/api/changeTerminalWorkStatus?terminal_no="+terminal_no+"&work_status="+(obj.elem.checked?"STOP":"START"),(function(d){if(0==d.code){if(obj.elem.checked){var el=$("#award_status_"+terminal_no);workListEl[terminal_no]=el;for(var i=0;i<all_terminal.length;i++)if(all_terminal[i].terminal_no==terminal_no){all_terminal[i].work_status="START";break}workList=Object.keys(workListEl),getWorkStatusTimer&&clearTimeout(getWorkStatusTimer),getWorkStatus()}else{delete workListEl[terminal_no];for(var i=0;i<all_terminal.length;i++)if(all_terminal[i].terminal_no==terminal_no){all_terminal[i].work_status="STOP";break}workList=Object.keys(workListEl)}layer.tips(d.msg,obj.othis)}else layer.tips(d.msg,obj.othis),obj.elem.checked=!obj.elem.checked,obj.othis.toggleClass("layui-form-checked")})).fail((function(){layer.tips("操作失败",obj.othis),obj.elem.checked=!obj.elem.checked,obj.othis.toggleClass("layui-form-checked")}))})),table.on("sort(winTicket)",(function(obj){table.reload("winTicket",{initSort:obj,where:{field:obj.field,order:obj.type},page:{curr:1}})}))}));